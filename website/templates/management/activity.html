{% extends "base.html" %}
{% block title %}活動管理{% endblock %}
{% block content %}
<div class="row align-items-center justify-content-between">
    <div class="col">
        <h1>活動管理</h1>
    </div>
    <div class="col d-md-flex justify-content-md-end">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#activityModal"
            data-bs-whatever="新增">新增</button>
        <!-- Modal -->
        <div class="modal fade" id="activityModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
            aria-labelledby="activityModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <form id="memberForm" method="POST" action="/management/activity/create">
                        <div class="modal-header">
                            <h5 class="modal-title" id="activityModalLabel">新增活動</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="clearModal();"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group" hidden>
                                <label for="activity_id">ID</label>
                                <input type="hidden" class="form-control" id="activity_id" name="activity_id" placeholder="Enter activity id">
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <label for="state">狀態</label>
                                        <select class="form-select" aria-label="Select state" id="state" name="state" required>
                                            <option value="0">取消(停辦)</option>
                                            <option value="1" selected>待舉辦</option>
                                            <option value="2">已舉辦</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <label for="name">活動名稱</label>
                                        <input type="text" class="form-control" id="name" name="name"
                                            placeholder="Enter name" required>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <label for="location">地點</label>
                                        <input type="text" class="form-control" id="location" name="location"
                                            placeholder="Enter location" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <label for="start_date">開始日期</label>
                                        <input type="date" class="form-control" id="start_date" name="start_date"
                                            placeholder="Enter start date" required onchange="checkDate('start_date')">
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <label for="end_date">結束日期</label>
                                        <input type="date" class="form-control" id="end_date" name="end_date"
                                            placeholder="Enter end date" required onchange="checkDate('end_date')">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <label for="description">活動內容</label>
                                        <textarea class="form-control" id="description" name="description" placeholder="Enter description" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <label for="participants">參加人員</label>
                                        <table class="table table-bordered text-center" id="participants" name="participants">
                                            <thead class="table-secondary">
                                                <tr class="table-light">
                                                    <th scope="col" colspan="5" >
                                                        <div class="row">
                                                            <div class="col-9">
                                                                <input class="form-control" list="datalistOptions" id="participantDataList" placeholder="Select the member...">
                                                                <datalist id="datalistOptions">
                                                                    {% for member in members %}
                                                                    <option value="{{ member.id }}_{{ member.name }}_({{ member.number_of_periods }})">
                                                                    {% endfor %}
                                                                </datalist>
                                                            </div>
                                                            <div class="col-3">
                                                                <button type="button" class="btn btn-success" id="addParticipant_btn" onclick="addParticipant()">新增</button>
                                                            </div>
                                                        </div>
                                                    </th>
                                                </tr>
                                                <tr>
                                                    <th scope="col">#</th>
                                                    <th scope="col">團員ID</th>
                                                    <th scope="col">姓名</th>
                                                    <th scope="col">期數</th>
                                                    <th scope="col">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="participantsList">
                                            </tbody>
                                        </table>
                                        <input type="hidden" class="form-control" id="participantList" name="participantList" placeholder="Enter staff List">
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <label for="staffs">服務人員</label>
                                        <table class="table table-bordered text-center" id="staffs" name="staffs">
                                            <thead class="table-secondary">
                                                <tr class="table-light">
                                                    <th scope="col" colspan="5" >
                                                        <div class="row">
                                                            <div class="col-9">
                                                                <input class="form-control" list="datalistOptions" id="staffDataList" placeholder="Select the member...">
                                                                <datalist id="datalistOptions">
                                                                    {% for member in members %}
                                                                    <option value="{{ member.id }}_{{ member.name }}_({{ member.numberOfPeriods }})">
                                                                    {% endfor %}
                                                                </datalist>
                                                            </div>
                                                            <div class="col-3">
                                                                <button type="button" class="btn btn-success" id="addStaff_btn" onclick="addStaff()">新增</button>
                                                            </div>
                                                        </div>
                                                    </th>
                                                </tr>
                                                <tr>
                                                    <th scope="col">#</th>
                                                    <th scope="col">團員ID</th>
                                                    <th scope="col">姓名</th>
                                                    <th scope="col">期數</th>
                                                    <th scope="col">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="staffsList">
                                            </tbody>
                                        </table>
                                        <input type="hidden" class="form-control" id="staffList" name="staffList" placeholder="Enter staff List">
                                    </div>
                                </div>
                            </div>
                            <br />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearModal()">取消</button>
                            <button type="submit" class="btn btn-primary">送出</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<table class="table table-hover text-center">
    <thead class="table-secondary">
        <tr>
            <th scope="col">#</th>
            <th scope="col">活動名稱</th>
            <th scope="col">開始日期</th>
            <th scope="col">結束日期</th>
            <th scope="col">地點</th>
            <th scope="col">狀態</th>       <!-- TODO:已舉辦、待舉辦、取消(停辦) -->
            <th scope="col">操作</th>
        </tr>
    </thead>
    <tbody>
        {% for i, activity in activities %}
        <tr class="{% if activity.state == '0' %}table-danger{% elif activity.state == '1' %}table-warning{% else %}table-success{% endif %}">
            <th scope="row">{{ i }}</th>
            <td id="name_{{ activity.id }}">{{ activity.name }}</td>
            <td id="startDate_{{ activity.id }}">{{ activity.start_date }}</td>
            <td id="endDate_{{ activity.id }}">{{ activity.end_date }}</td>
            <td id="location_{{ activity.id }}">{{ activity.location }}</td>
            <td id="state_{{ activity.id }}">
                {% if activity.state == '0' %}取消(停辦){% elif activity.state == '1' %}待舉辦{% else %}已舉辦{% endif%}
            </td>
            <td>
                <div class="row justify-content-center">
                    <div class="col-5">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#activityModal" data-bs-whatever="編輯_{{ activity.id }}">詳細資訊</button>
                    </div>
                    <div class="col-2">
                        <form method="post" action="/management/activity/delete" id="deleteForm">
                            <input type="hidden" class="form-control" id="delete_id" name="delete_id" placeholder="Enter activity id" value="{{ activity.id }}">
                            <button type="button" class="btn btn-danger" onclick="deleteActivity({{activity.id}})">
                                <i class='fa-solid fa-trash-can'></i>
                            </button>
                        </form>
                    </div>
                    <div class="col-5">
                        {% if activity.allowed == "0": %}
                        <form method="post" action="/management/activity/allowed" id="allowedForm">
                            <input type="hidden" class="form-control" id="allowed_id" name="allowed_id" placeholder="Enter activity id" value="{{ activity.id }}">
                            <button type="button" class="btn btn-warning" onclick="allowedActivity({{activity.id}})">允許新增紀錄</button>
                        </form>
                        {% endif%}
                    </div>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    function addRowForTable(_tableId, _mid, _name, _num, mode) {
        var table = document.getElementById(`${_tableId}`);
        var row = table.insertRow(-1);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        var cell5 = row.insertCell(4);
        cell1.innerHTML = table.rows.length;
        cell2.innerHTML = _mid;
        cell3.innerHTML = _name;
        cell4.innerHTML = _num;
        if (mode == "staff") {
            cell5.innerHTML = `<button type='button' class='btn' id='deleteStaff_${table.rows.length}_btn' onclick='deleteStaff("${_mid}", "${_name}", "${_num}")'><i class='fa-solid fa-trash-can'></i></button>`;
        } else if (mode == "participant") {
            cell5.innerHTML = `<button type='button' class='btn' id='deleteParticipant_${table.rows.length}_btn' onclick='deleteParticipant("${_mid}", "${_name}", "${_num}")'><i class='fa-solid fa-trash-can'></i></button>`;
        }
    }

    function deleteAllRowForTable(_tableId) {
        var table = document.getElementById(`${_tableId}`);
        // 刪除所有的row
        for (var i = table.rows.length - 1; i > 0; i--) {
            table.deleteRow(i); // 從最後一行開始刪
        }
        if (table.rows.length > 0) {
            table.deleteRow(0);
        }
    }

    function getMidToField(_fieldId, _list) {
        var temp = [];
        for (var i = 0; i < _list.length; i++) {
            temp.push(_list[i].mid);
        }
        document.getElementById(`${_fieldId}`).value = JSON.stringify(temp);
    }

    var _participantsList = [];
    var _staffsList = [];

    function addParticipant() {
        if (document.getElementById("participantDataList").value == "") {
            alert("請選擇人員");
            return;
        }

        var member = document.getElementById("participantDataList").value.split("_");
        var member_id = member[0].replace(/\s*/g,"");
        var member_name = member[1].replace(/\s*/g,"");
        var member_numberOfPeriods = member[2].replace("(", "").replace(")", "").replace(/\s*/g,"");

        for (var i = 0; i < _staffsList.length; i++) {
            if (_staffsList[i].mid == member_id && _staffsList[i].name == member_name && _staffsList[i].num == member_numberOfPeriods) {
                alert("此人員已新增進工作人員名單，請先刪除工作人員名單中的此人員，方可新增");
                document.getElementById("participantDataList").value = "";
                return;
            }
        }
        for (var i = 0; i < _participantsList.length; i++) {
            if (_participantsList[i].mid == member_id && _participantsList[i].name == member_name && _participantsList[i].num == member_numberOfPeriods) {
                alert("已新增過此人員");
                document.getElementById("participantDataList").value = "";
                return;
            }
        }
        _participantsList.push({ mid: member_id, name: member_name, num: member_numberOfPeriods });
        getMidToField("participantList", _participantsList);

        addRowForTable("participantsList", member_id, member_name, member_numberOfPeriods, "participant");
        document.getElementById("participantDataList").value = "";
    }

    function deleteParticipant(mid, name, num) {
        _participantsList = _participantsList.filter((value) => {
            return (value.mid != mid || value.name != name || value.num != num)
        });
        getMidToField("participantList", _participantsList);

        // 刪除所有的row
        deleteAllRowForTable("participantsList")

        // 重新新增row
        for (var i = 0; i < _participantsList.length; i++) {
            addRowForTable("participantsList", _participantsList[i].mid, _participantsList[i].name, _participantsList[i].num, "participant");
        }
    }

    function addStaff() {
        if (document.getElementById("staffDataList").value == "") {
            alert("請選擇人員");
            return;
        }

        var member = document.getElementById("staffDataList").value.split("_");
        var member_id = member[0].replace(/\s*/g,"");
        var member_name = member[1].replace(/\s*/g,"");
        var member_numberOfPeriods = member[2].replace("(", "").replace(")", "").replace(/\s*/g,"");

        for (var i = 0; i < _participantsList.length; i++) {
            if (_participantsList[i].mid == member_id && _participantsList[i].name == member_name && _participantsList[i].num == member_numberOfPeriods) {
                alert("此人員已新增進參加人員名單，請先刪除參加人員名單中的此人員，方可新增");
                document.getElementById("staffDataList").value = "";
                return;
            }
        }
        for (var i = 0; i < _staffsList.length; i++) {
            if (_staffsList[i].mid == member_id && _staffsList[i].name == member_name && _staffsList[i].num == member_numberOfPeriods) {
                alert("已新增過此人員");
                document.getElementById("staffDataList").value = "";
                return;
            }
        }
        _staffsList.push({ mid: member_id, name: member_name, num: member_numberOfPeriods });
        getMidToField("staffList", _staffsList);

        addRowForTable("staffsList", member_id, member_name, member_numberOfPeriods, "staff");
        document.getElementById("staffDataList").value = "";
    }

    function deleteStaff(mid, name, num) {
        _staffsList = _staffsList.filter((value) => {
            return (value.mid != mid || value.name != name || value.num != num)
        });
        getMidToField("staffList", _staffsList);

        // 刪除所有的row
        deleteAllRowForTable("staffsList")

        // 重新新增row
        for (var i = 0; i < _staffsList.length; i++) {
            addRowForTable("staffsList", _staffsList[i].mid, _staffsList[i].name, _staffsList[i].num, "staff");
        }
    }

    function clearModal() {
        _participantsList = [];
        deleteAllRowForTable("participantsList");
        _staffsList = [];
        deleteAllRowForTable("staffsList");
        document.getElementById("name").value = "";
        document.getElementById("start_date").value = "";
        document.getElementById("end_date").value = "";
        document.getElementById("location").value = "";
        document.getElementById("description").value = "";
        document.getElementById("participantList").value = "";
        document.getElementById("staffList").value = "";
        document.getElementById("state").value = "1";
    }

    var activityModal = document.getElementById('activityModal')
    activityModal.addEventListener('show.bs.modal', function (event) {
        // Button that triggered the modal
        var button = event.relatedTarget
        // Extract info from data-bs-* attributes
        var recipient = button.getAttribute('data-bs-whatever')
        // If necessary, you could initiate an AJAX request here
        // and then do the updating in a callback.
        //
        // Update the modal's content.
        var modalTitle = activityModal.querySelector('.modal-title')
        var modalBodyInput = activityModal.querySelector('.modal-body input')

        if (recipient == '新增') {
            document.getElementById("memberForm").action = "/management/activity/create";
            modalTitle.textContent = recipient + '活動';
        } else if (recipient.includes("編輯")) {
            document.getElementById("memberForm").action = "/management/activity/edit";
            modalTitle.textContent = recipient.split("_")[0] + '活動'
            var id = recipient.split("_")[1];
            fetch('/management/activity', {
                method: 'POST',
                body: JSON.stringify({ 'activity_id': id }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("activity_id").value = data.id;
                document.getElementById("name").value = data.name;
                document.getElementById("start_date").value = data.start_date;
                document.getElementById("end_date").value = data.end_date;
                document.getElementById("location").value = data.location;
                document.getElementById("description").value = data.description;
                document.getElementById("state").value = data.state;
                // 判斷是否有參加人員
                if (data.participants != "") {
                    var jsonParticipants = JSON.parse(data.participants);
                    getParticipantsForEditMode(jsonParticipants);
                }
                // 判斷是否有服務人員
                if (data.staffs != "") {
                    var jsonStaffs = JSON.parse(data.staffs);
                    getStaffsForEditMode(jsonStaffs);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    })

    function removeDuplicateObjects(jsonArray) {
        const uniqueObjects = [];
        const seenObjects = {};

        for (const obj of jsonArray) {
            // 將JSON轉為字串，以方便比較
            const objStr = JSON.stringify(obj);

            if (!seenObjects[objStr]) {
                // 如果未见过这个对象，将其添加到结果数组和已见对象字典中
                uniqueObjects.push(obj);
                seenObjects[objStr] = true;
            }
        }
        return uniqueObjects;
    }

    function getParticipantsForEditMode(jsonParticipants) {
        var fetchPromises_participants = [];
        for (var i = 0; i < jsonParticipants.length; i++) {
            var fetchPromise = fetch('/management/member', {
                method: 'POST',
                body: JSON.stringify({ 'member_id': jsonParticipants[i] }),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                return { mid: data.id, name: data.name, num: data.number_of_periods };
            })
            .catch((error) => {
                console.error('Error:', error);
            });
            fetchPromises_participants.push(fetchPromise);
        }

        Promise.all(fetchPromises_participants)
            .then(participantsData => {
                _participantsList = participantsData;
                getMidToField("participantList", _participantsList);

                var removeDuplicateParticipants = removeDuplicateObjects(_participantsList);
                for (var i = 0; i < removeDuplicateParticipants.length; i++) {
                    addRowForTable("participantsList", removeDuplicateParticipants[i].mid, removeDuplicateParticipants[i].name, removeDuplicateParticipants[i].num, "participant");
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    function getStaffsForEditMode(jsonStaffs) {
        var fetchPromises_staffs = [];
        for (var i = 0; i < jsonStaffs.length; i++) {
            var fetchPromise = fetch('/management/member', {
                method: 'POST',
                body: JSON.stringify({ 'member_id': jsonStaffs[i] }),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                return { mid: data.id, name: data.name, num: data.number_of_periods };
            })
            .catch((error) => {
                console.error('Error:', error);
            });
            fetchPromises_staffs.push(fetchPromise);
        }

        Promise.all(fetchPromises_staffs)
            .then(participantsData => {
                _staffsList = participantsData;
                getMidToField("staffList", _staffsList);

                var removeDuplicateStaffs = removeDuplicateObjects(_staffsList);
                for (var i = 0; i < removeDuplicateStaffs.length; i++) {
                    addRowForTable("staffsList", removeDuplicateStaffs[i].mid, removeDuplicateStaffs[i].name, removeDuplicateStaffs[i].num, "staff");
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    function deleteActivity(activity_id) {
        if (confirm('你確定要刪除此筆活動紀錄嗎?')) {
            document.getElementById("delete_id").value = activity_id;
            document.getElementById("deleteForm").submit();
        }
    }

    function allowedActivity(activity_id) {
        if (confirm('你確定要允許此筆活動紀錄新增嗎?')) {
            document.getElementById("allowed_id").value = activity_id;
            document.getElementById("allowedForm").submit();
        }
    }

    function checkDate(dateField_id) {
        var startDate = new Date(document.getElementById("start_date").value);
        var endDate = new Date(document.getElementById("end_date").value);
        if (startDate > endDate) {
            alert("結束日期不可早於開始日期");
            document.getElementById(`${dateField_id}`).value = "";
        }
    }
</script>
{% endblock %}
